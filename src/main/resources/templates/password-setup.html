<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Password Setup</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; }
        h2 { color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        input:invalid { border-color: #dc3545; } /* Red border for invalid input */
        input:valid { border-color: #28a745; } /* Green border for valid input */
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .error { color: #dc3545; display: none; margin-top: 5px; }
        .reset-btn { background-color: #6c757d; margin-left: 10px; }
        .reset-btn:hover { background-color: #5a6268; }
    </style>
</head>
<body>
<h2>Password Setup</h2>
<form id="passwordSetupForm" th:action="@{/api/tenant/setup-password}" method="post" th:object="${passwordSetupRequest}">
    <input type="hidden" th:field="*{email}" />
    <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" th:field="*{password}" id="password" required />
        <div class="error" id="passwordError">Password is required.</div>
    </div>
    <div class="form-group">
        <label for="confirmPassword">Confirm Password:</label>
        <input type="password" id="confirmPassword" required />
        <div class="error" id="confirmError">Passwords do not match.</div>
    </div>
    <button type="submit">Save Password</button>
    <button type="button" class="reset-btn" id="resetBtn">Reset</button>
</form>

<script>
    document.getElementById('passwordSetupForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmPassword');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');

        if (!passwordInput.value.trim()) {
            passwordError.style.display = 'block';
            return;
        } else {
            passwordError.style.display = 'none';
        }

        if (passwordInput.value !== confirmInput.value) {
            confirmError.style.display = 'block';
            return;
        } else {
            confirmError.style.display = 'none';
        }

        const formData = {
            email: document.getElementById('email').value,
            password: passwordInput.value
        };

        try {
            const response = await fetch('/api/tenant/setup-password?token=' + new URLSearchParams(window.location.search).get('token'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData).toString()
            });

            if (response.ok) {
                alert('Password set successfully. Please login.');
                window.location.href = '/login';
            } else {
                const error = await response.text();
                alert('Registration failed: ' + error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('passwordSetupForm').reset();
        document.getElementById('passwordError').style.display = 'none';
        document.getElementById('confirmError').style.display = 'none';
    });
</script>
</body>
</html>